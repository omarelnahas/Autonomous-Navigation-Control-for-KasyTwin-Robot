<?xml version="1.0"?>
<robot name="tracked_vehicle" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- Properties -->
  <xacro:property name="pi" value="3.14159265359"/>
  
  <!-- Base link properties -->
  <xacro:property name="base_length" value="0.50017"/>
  <xacro:property name="base_width" value="0.24093"/>
  <xacro:property name="base_height" value="0.139"/>
  <xacro:property name="base_mass" value="13.14"/>
  
  <!-- Track properties -->
  <xacro:property name="track_separation" value="0.1985"/>
  <xacro:property name="track_mass" value="2.06"/>
  <xacro:property name="track_box_width" value="0.009728"/>
  <xacro:property name="track_box_height" value="0.018094"/>
  <xacro:property name="track_box_length" value="0.05"/>
  <xacro:property name="track_z_offset" value="0.01855"/>
  
  <!-- Wheel properties -->
  <xacro:property name="wheel_mass" value="0.5"/>
  <xacro:property name="wheel_radius" value="0.09047"/>
  <xacro:property name="wheel_length" value="0.09728"/>
  <xacro:property name="wheel_separation" value="0.493"/>
  
  <!-- Friction properties -->
  <xacro:property name="mu" value="0.5"/>
  <xacro:property name="mu2" value="1"/>

  <!-- Base Link -->
  <link name="base_link">
    <inertial>
      <origin xyz="-0.122 0 0.118" rpy="${pi/2} 0 0"/>
      <mass value="${base_mass}"/>
      <inertia ixx="0.10019" ixy="0" ixz="0"
               iyy="0.345043" iyz="0"
               izz="0.302044"/>
    </inertial>
    
    <collision name="base_link_collision">
      <origin xyz="-0.122 0 0.118" rpy="0 0 0"/>
      <geometry>
        <box size="${base_length} ${base_width} ${base_height}"/>
      </geometry>
    </collision>
    
    <visual name="base_link_visual">
      <origin xyz="-0.122 0 0.118" rpy="0 0 0"/>
      <geometry>
        <box size="${base_length} ${base_width} ${base_height}"/>
      </geometry>
      <material name="blue">
        <color rgba="0.5 0.5 1.0 1"/>
      </material>
    </visual>
  </link>

  <!-- Macro for track body (fixed to base) -->
  <xacro:macro name="track_body" params="prefix reflect">
    <link name="${prefix}_track">
      <inertial>
        <mass value="${track_mass}"/>
        <inertia ixx="0.002731" ixy="0" ixz="0"
                 iyy="0.032554" iyz="0"
                 izz="0.031391"/>
      </inertial>
      
      <collision name="${prefix}_track_collision">
        <origin xyz="0 0 ${track_z_offset}" rpy="${pi/2} 0 ${pi/2}"/>
        <geometry>
          <box size="${track_box_width} ${track_box_height} ${track_box_length}"/>
        </geometry>
      </collision>
    </link>
    
    <joint name="${prefix}_track_j" type="fixed">
      <parent link="base_link"/>
      <child link="${prefix}_track"/>
      <origin xyz="0 ${reflect * track_separation} 0" rpy="0 0 0"/>
    </joint>
  </xacro:macro>

  <!-- Macro for individual track wheels -->
  <xacro:macro name="track_wheel" params="prefix wheel_num x_pos reflect">
    <link name="${prefix}_track_wheel${wheel_num}">
      <inertial>
        <mass value="${wheel_mass}"/>
        <inertia ixx="0.001" ixy="0" ixz="0"
                 iyy="0.001" iyz="0"
                 izz="0.001"/>
      </inertial>
      
      <collision name="${prefix}_track_wheel${wheel_num}_collision">
        <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
        <geometry>
          <cylinder length="${wheel_length}" radius="${wheel_radius}"/>
        </geometry>
        <surface>
          <friction>
            <ode>
              <mu>${mu}</mu>
              <mu2>${mu2}</mu2>
              <fdir1>0 0 1</fdir1>
              <slip1>0</slip1>
              <slip2>0</slip2>
            </ode>
          </friction>
        </surface>
      </collision>
      
      <visual name="${prefix}_track_wheel${wheel_num}_visual">
        <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
        <geometry>
          <cylinder length="${wheel_length}" radius="${wheel_radius}"/>
        </geometry>
        <material name="dark_gray">
          <color rgba="0.3 0.3 0.3 1"/>
        </material>
      </visual>
    </link>
    
    <joint name="${prefix}_track_wheel${wheel_num}_j" type="revolute">
      <parent link="${prefix}_track"/>
      <child link="${prefix}_track_wheel${wheel_num}"/>
      <origin xyz="${x_pos} 0 ${track_z_offset}" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
      <limit lower="-1e+16" upper="1e+16" effort="100" velocity="100"/>
    </joint>
  </xacro:macro>

  <!-- Instantiate left track -->
  <xacro:track_body prefix="left" reflect="1"/>
  <xacro:track_wheel prefix="left" wheel_num="1" x_pos="0.25" reflect="1"/>
  <xacro:track_wheel prefix="left" wheel_num="2" x_pos="0.1786" reflect="1"/>
  <xacro:track_wheel prefix="left" wheel_num="3" x_pos="0.1072" reflect="1"/>
  <xacro:track_wheel prefix="left" wheel_num="4" x_pos="0.0358" reflect="1"/>
  <xacro:track_wheel prefix="left" wheel_num="5" x_pos="-0.0358" reflect="1"/>
  <xacro:track_wheel prefix="left" wheel_num="6" x_pos="-0.1072" reflect="1"/>
  <xacro:track_wheel prefix="left" wheel_num="7" x_pos="-0.1786" reflect="1"/>
  <xacro:track_wheel prefix="left" wheel_num="8" x_pos="-0.25" reflect="1"/>

  <!-- Instantiate right track -->
  <xacro:track_body prefix="right" reflect="-1"/>
  <xacro:track_wheel prefix="right" wheel_num="1" x_pos="0.25" reflect="-1"/>
  <xacro:track_wheel prefix="right" wheel_num="2" x_pos="0.1786" reflect="-1"/>
  <xacro:track_wheel prefix="right" wheel_num="3" x_pos="0.1072" reflect="-1"/>
  <xacro:track_wheel prefix="right" wheel_num="4" x_pos="0.0358" reflect="-1"/>
  <xacro:track_wheel prefix="right" wheel_num="5" x_pos="-0.0358" reflect="-1"/>
  <xacro:track_wheel prefix="right" wheel_num="6" x_pos="-0.1072" reflect="-1"/>
  <xacro:track_wheel prefix="right" wheel_num="7" x_pos="-0.1786" reflect="-1"/>
  <xacro:track_wheel prefix="right" wheel_num="8" x_pos="-0.25" reflect="-1"/>

  <!-- Gazebo Differential Drive Plugin -->
  <gazebo>
    <plugin filename="ignition-gazebo-diff-drive-system" 
            name="gz::sim::systems::DiffDrive">
      <!-- Left track wheels -->
      <left_joint>left_track_wheel1_j</left_joint>
      <left_joint>left_track_wheel2_j</left_joint>
      <left_joint>left_track_wheel3_j</left_joint>
      <left_joint>left_track_wheel4_j</left_joint>
      <left_joint>left_track_wheel5_j</left_joint>
      <left_joint>left_track_wheel6_j</left_joint>
      <left_joint>left_track_wheel7_j</left_joint>
      <left_joint>left_track_wheel8_j</left_joint>
      
      <!-- Right track wheels -->
      <right_joint>right_track_wheel1_j</right_joint>
      <right_joint>right_track_wheel2_j</right_joint>
      <right_joint>right_track_wheel3_j</right_joint>
      <right_joint>right_track_wheel4_j</right_joint>
      <right_joint>right_track_wheel5_j</right_joint>
      <right_joint>right_track_wheel6_j</right_joint>
      <right_joint>right_track_wheel7_j</right_joint>
      <right_joint>right_track_wheel8_j</right_joint>
      
      <wheel_separation>${wheel_separation}</wheel_separation>
      <wheel_radius>${wheel_radius}</wheel_radius>
      
      <topic>karo/pid/cmd_vel</topic>
      <odom_topic>odometry</odom_topic>
      <frame_id>odom</frame_id>
      <child_frame_id>base_link</child_frame_id>
    </plugin>
  </gazebo>
</robot>